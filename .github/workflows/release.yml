name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v1.1.0

jobs:
  test:
    name: Test before release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Nextflow
        uses: nf-core/setup-nextflow@v2

      - name: Run full pipeline
        run: nextflow run main.nf -profile docker,test

      - name: Verify all outputs
        run: |
          test -f results/fastqc/sample_R1_fastqc.html
          test -f results/multiqc/multiqc_report.html
          test -f results/alignments/test_sample.sorted.bam
          test -f results/variants/test_sample.vcf.gz

  release:
    name: Create GitHub Release
    needs: test  # Only runs if tests pass
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
